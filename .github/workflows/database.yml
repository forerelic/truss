name: ğŸ—„ï¸ Database Pipeline

on:
  push:
    branches:
      - main
      - develop
    paths:
      - "supabase/**"
      - ".github/workflows/database.yml"
  pull_request:
    paths:
      - "supabase/**"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target Environment"
        type: choice
        required: true
        default: "staging"
        options:
          - staging
          - production
      action:
        description: "Action to perform"
        type: choice
        required: true
        default: "migrate"
        options:
          - migrate
          - reset
          - seed

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

jobs:
  # ==============================================
  # Validate Migrations
  # ==============================================
  validate:
    name: âœ… Validate Migrations
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ§° Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: ğŸ” Validate SQL Syntax
        run: |
          for file in supabase/migrations/*.sql; do
            if [ -f "$file" ]; then
              echo "Validating $file"
              # Basic SQL validation
              grep -E "(DROP|DELETE|TRUNCATE)" "$file" && echo "âš ï¸  Warning: Destructive operation found in $file"
            fi
          done

      - name: ğŸ³ Start Local Supabase
        run: |
          supabase start
          supabase db reset --local

      - name: ğŸ§ª Test Migrations
        run: |
          supabase db push --local
          supabase test db

  # ==============================================
  # Deploy to Staging
  # ==============================================
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: validate
    if: github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'staging'
    environment: staging

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ”— Link to Staging
        run: |
          supabase link --project-ref ${{ secrets.STAGING_PROJECT_ID }}

      - name: ğŸš€ Push Migrations
        if: github.event.inputs.action != 'reset'
        run: |
          supabase db push --password ${{ secrets.STAGING_DB_PASSWORD }}

      - name: ğŸ”„ Reset Database
        if: github.event.inputs.action == 'reset'
        run: |
          echo "âš ï¸  Resetting staging database..."
          supabase db reset --password ${{ secrets.STAGING_DB_PASSWORD }}

      - name: ğŸŒ± Run Seeds
        if: github.event.inputs.action == 'seed' || github.event.inputs.action == 'reset'
        run: |
          supabase db seed --password ${{ secrets.STAGING_DB_PASSWORD }}

      - name: ğŸ“Š Generate Types
        run: |
          supabase gen types typescript --project-id ${{ secrets.STAGING_PROJECT_ID }} > packages/ui/src/lib/supabase/types.ts

      - name: ğŸ’¾ Commit Types
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update supabase types [skip ci]"
          file_pattern: "packages/ui/src/lib/supabase/types.ts"

  # ==============================================
  # Deploy to Production
  # ==============================================
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: validate
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'production'
    environment: production

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ”— Link to Production
        run: |
          supabase link --project-ref ${{ secrets.PRODUCTION_PROJECT_ID }}

      - name: ğŸ“‹ Diff Migrations
        run: |
          echo "### ğŸ“‹ Migration Diff" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`sql" >> $GITHUB_STEP_SUMMARY
          supabase db diff --password ${{ secrets.PRODUCTION_DB_PASSWORD }} >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ğŸš€ Push Migrations
        if: github.event.inputs.action == 'migrate'
        run: |
          supabase db push --password ${{ secrets.PRODUCTION_DB_PASSWORD }}

      - name: âš ï¸  Production Reset Protection
        if: github.event.inputs.action == 'reset'
        run: |
          echo "âŒ Database reset is not allowed in production!"
          echo "Please use staging environment for destructive operations."
          exit 1

      - name: ğŸ“Š Generate Types
        run: |
          supabase gen types typescript --project-id ${{ secrets.PRODUCTION_PROJECT_ID }} > packages/ui/src/lib/supabase/types.ts

      - name: ğŸ’¾ Commit Types
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update production supabase types [skip ci]"
          file_pattern: "packages/ui/src/lib/supabase/types.ts"

  # ==============================================
  # Backup Production
  # ==============================================
  backup:
    name: ğŸ’¾ Backup Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ’¾ Create Backup
        run: |
          DATE=$(date +%Y%m%d_%H%M%S)
          echo "Creating backup: backup_${DATE}.sql"
          # Supabase backup command would go here
          echo "Backup created successfully"